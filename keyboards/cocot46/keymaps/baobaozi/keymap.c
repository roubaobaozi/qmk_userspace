#include QMK_KEYBOARD_H
#include <stdio.h>

#include "paw3204.h"
#include "pointing_device.h"

#include "baobaozi.h"

bool isScrollMode;

enum custom_keycodes {
    MBTN1 = SAFE_RANGE,
    MBTN2,
    MBTN3,
    SCRL
};

/* Re-pass though to allow templates to be used */
#define LAYOUT_wrapper(...) LAYOUT(__VA_ARGS__)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    [_COLEMAK] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            KC_TAB   ,_________________ROW_TOP_COLMK_L_________________,                           _________________ROW_TOP_COLMK_R_________________,KC_BSPC  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            LTN(GRV) ,_________________ROW_MID_COLMK_L_________________,                           _________________ROW_MID_COLMK_R_________________,LTN(ENT) ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            OS(LSFT) ,_________________ROW_BOT_COLMK_L_________________,KC_MS_BTN1  ,KC_MS_BTN2   ,_________________ROW_BOT_COLMK_R_________________,OS(RSFT) ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      __T_L4___,KC_1     ,__T_L3___,__T_L2___,__T_L1___,         KC_5     ,        __T_R1___,__T_R2___,__T_R2B__,KC_2     ,__T_R3___
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

    [_QWERTY] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_QWERT_L_________________,                           _________________ROW_TOP_QWERT_R_________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_QWERT_L_________________,                           _________________ROW_MID_QWERT_R_________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_QWERT_L_________________,_______     ,_______      ,_________________ROW_BOT_QWERT_R_________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

    [_NAV] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_NAV_L___________________,                           _________________ROW_TOP_NAV_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_NAV_L___________________,                           _________________ROW_MID_NAV_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_NAV_L___________________,_______     ,_______      ,_________________ROW_BOT_NAV_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

#if defined(TEST_SYN)
    [_SYN] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_SYN_L___________________,                           _________________ROW_TOP_SYN_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_SYN_L___________________,                           _________________ROW_MID_SYN_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_SYN_L___________________,_______     ,_______      ,_________________ROW_BOT_SYN_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),
#else
    [_SYM] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_SYM_L___________________,                           _________________ROW_TOP_SYM_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_SYM_L___________________,                           _________________ROW_MID_SYM_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_SYM_L___________________,_______     ,_______      ,_________________ROW_BOT_SYM_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

    [_NUM] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_NUM_L___________________,                           _________________ROW_TOP_NUM_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_NUM_L___________________,                           _________________ROW_MID_NUM_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_NUM_L___________________,_______     ,_______      ,_________________ROW_BOT_NUM_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),
#endif

    [_CUR] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_CUR_L___________________,                           _________________ROW_TOP_CUR_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_CUR_L___________________,                           _________________ROW_MID_CUR_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_CUR_L___________________,_______     ,_______      ,_________________ROW_BOT_CUR_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

    [_FNC] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_FNC_L___________________,                           _________________ROW_TOP_FNC_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_FNC_L___________________,                           _________________ROW_MID_FNC_R___________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_FNC_L___________________,_______     ,_______      ,_________________ROW_BOT_FNC_R___________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),

    [_KB] = LAYOUT_wrapper(
        // ┌─ Extra ─┬─── Q ───┬─── W ───┬─── F ───┬─── P ───┬─── G ───┐                          ┌─── J ───┬─── L ───┬─── U ───┬─── Y ───┬─── ; ───┬─ Extra ─┐
            _______  ,_________________ROW_TOP_KB_L____________________,                           _________________ROW_TOP_KB_R____________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_MID_KB_L____________________,                           _________________ROW_MID_KB_R____________________,_______  ,
        // ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤                          ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
            _______  ,_________________ROW_BOT_KB_L____________________,_______     ,_______      ,_________________ROW_BOT_KB_R____________________,_______  ,
        // └─────────┴─────────┼─────────┼─────────┼─────────┼─────────┤        ┌─────────┐       ├─────────┼─────────┼─────────┼─────────┼─────────┴─────────┘
                      _______  ,_______  ,_______  ,_______  ,_______  ,         _______  ,        _______  ,_______  ,_______  ,_______  ,_______
                  // └─────────┴─────────┴─────────┴─────────┴─────────┘        └─────────┘       └─────────┴─────────┴─────────┴─────────┴─────────┘
    ),
};


char keylog_str[24] = {};

const char code_to_name[60] = {
    ' ', ' ', ' ', ' ', 'a', 'b', 'c', 'd', 'e', 'f',
    'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p',
    'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
    '1', '2', '3', '4', '5', '6', '7', '8', '9', '0',
    'R', 'E', 'B', 'T', '_', '-', '=', '[', ']' , '\\',
    '#', ';', '\'', '`', ',', '.', '/', ' ', ' ', ' '};

void set_keylog(uint16_t keycode, keyrecord_t *record) {
  char name = ' ';
    if ((keycode >= QK_MOD_TAP && keycode <= QK_MOD_TAP_MAX) ||
        (keycode >= QK_LAYER_TAP && keycode <= QK_LAYER_TAP_MAX)) { keycode = keycode & 0xFF; }
  if (keycode < 60) {
    name = code_to_name[keycode];
  }

  // update keylog
  snprintf(keylog_str, sizeof(keylog_str), "%dx%d, k%2d : %c",
           record->event.key.row, record->event.key.col,
           keycode, name);
}


keyevent_t encoder1_ccw = {
    .key = (keypos_t){.row = 3, .col = 6},
    .pressed = false
};

keyevent_t encoder1_cw = {
    .key = (keypos_t){.row = 2, .col = 6},
    .pressed = false
};

bool encoder_update_user(uint8_t index, bool clockwise) {
    if (index == 0) { /* First encoder */
        if (clockwise) {
            encoder1_cw.pressed = true;
            encoder1_cw.time = (timer_read() | 1);
            action_exec(encoder1_cw);
        } else {
            encoder1_ccw.pressed = true;
            encoder1_ccw.time = (timer_read() | 1);
            action_exec(encoder1_ccw);
        }
    }

    return true;
}

bool process_record_keymap(uint16_t keycode, keyrecord_t *record) {
// bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  report_mouse_t currentReport = {};

  switch (keycode) {
    case MBTN1:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
        currentReport.buttons |= MOUSE_BTN1;
      }
      else {
        currentReport.buttons &= ~MOUSE_BTN1;
      }
      pointing_device_set_report(currentReport);
      return false;
    case MBTN2:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
        currentReport.buttons |= MOUSE_BTN2;
      }
      else {
        currentReport.buttons &= ~MOUSE_BTN2;
      }
      pointing_device_set_report(currentReport);
      return false;
    case MBTN3:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
        currentReport.buttons |= MOUSE_BTN3;
      }
      else {
        currentReport.buttons &= ~MOUSE_BTN3;
      }
      pointing_device_set_report(currentReport);
      return false;
    case SCRL:
      if (record->event.pressed) {
        isScrollMode = true;
        dprint("scroll ON\n");
      }
      else {
        isScrollMode = false;
        dprint("scroll OFF\n");
      }
      return false;
  }
  return true;
}

void matrix_init_user(void) {
    init_paw3204();
}

void matrix_scan_user(void) {
    static int  cnt;
    static bool paw_ready;

    report_mouse_t mouse_rep = pointing_device_get_report();

    if (IS_PRESSED(encoder1_ccw)) {
        encoder1_ccw.pressed = false;
        encoder1_ccw.time = (timer_read() | 1);
        action_exec(encoder1_ccw);
    }

    if (IS_PRESSED(encoder1_cw)) {
        encoder1_cw.pressed = false;
        encoder1_cw.time = (timer_read() | 1);
        action_exec(encoder1_cw);
    }

    if (cnt++ % 50 == 0) {
        uint8_t pid = read_pid_paw3204();
        if (pid == 0x30) {
            dprint("paw3204 OK\n");
            paw_ready = true;
        } else {
            dprintf("paw3204 NG:%d\n", pid);
            paw_ready = false;
        }
    }

    if (paw_ready) {
        uint8_t stat;
        int8_t x, y;
        int8_t r_x, r_y;

        read_paw3204(&stat, &x, &y);

        // 45-degree angle
        int8_t degree = 45;
        r_x =  + x * cos(degree) + y * sin(degree);
        r_y =  - x * sin(degree) + y * cos(degree);
        // int8_t degree = -45;
        // r_x =  - x * cos(degree) - y * sin(degree);
        // r_y =  + x * sin(degree) - y * cos(degree);
        /* normal angle
        r_x = y;
        r_y = x;
        */

        if (isScrollMode) {
            if (cnt % 5 == 0) {
                mouse_rep.v = -r_y;
                mouse_rep.h = r_x;
            }
        } else {
            mouse_rep.x = r_x;
            mouse_rep.y = r_y;
        }

        if (cnt % 10 == 0) {
            dprintf("stat:%3d x:%4d y:%4d\n", stat, mouse_rep.x, mouse_rep.y);
        }

        if (stat & 0x80) {
            pointing_device_set_report(mouse_rep);
        }
    }
}

layer_state_t layer_state_set_keymap(layer_state_t state) {
    switch (get_highest_layer(state)) {
    case _NAV:
        isScrollMode = true;
        break;
    case _SYM:
        isScrollMode = true;
        break;
    default:
        isScrollMode = false;
        break;
    }
  return state;
}
